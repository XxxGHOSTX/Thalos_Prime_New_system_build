name: Deploy Application

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.thalos-prime.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run tests
      run: |
        python test_system.py
        echo "✓ Tests passed for staging deployment"
    
    - name: Deploy
      run: |
        echo "Deploying THALOS Prime to staging environment..."
        # Add actual deployment commands here
        echo "✓ Staging deployment complete"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://thalos-prime.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run tests
      run: |
        # Add src to Python path for test_complete_system.py
        export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
        python test_system.py
        python test_complete_system.py
        echo "✓ All tests passed for production deployment"
    
    - name: Deploy
      run: |
        echo "Deploying THALOS Prime to production environment..."
        # Add actual deployment commands here
        echo "✓ Production deployment complete"
    
    - name: Health check
      run: |
        echo "Running post-deployment health checks..."
        # Add health check commands
        echo "✓ Health checks passed"
